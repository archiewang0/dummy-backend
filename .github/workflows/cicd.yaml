name: CI/CD Pipeline

on:
  push:
    branches:
      - master  # 當推送到主分支時觸發
  pull_request:
    branches:
      - master  # 當對主分支的拉取請求時觸發

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Google Cloud Auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '20'  # 使用 Node.js 版本 20

      - name: Install dependencies
        run: npm install

      - name: Build the project
        run: npm run build

      - name: Run tests
        run: npm test  # 如果有測試的話，這裡可以執行測試

      - name: Deploy
        run: |
          npm run build
          npm run start



# ------------------------

# env:
#   SERVICE_NAME: custom-fastapi-service
#   PROJECT_ID: h-t-d-a-f-a-t-g-c-r
#   DOCKER_IMAGE_URL: us-central1-docker.pkg.dev/h-t-d-a-f-a-t-g-c-r/custom-fastapi/custom-fastapi


# on:
#   push:
#     branches:
#       - master
#   pull_request:
#     branches:
#       - master

# jobs:
#   dockerize-and-deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v2

#       - name: Google Cloud Auth
#         uses: 'google-github-actions/auth@v2'
#         with:
#           credentials_json: '${{ secrets.GCP_SA_KEY }}'
#           project_id: ${{ env.PROJECT_ID }}

#       - name: Set up Cloud SDK
#         uses: 'google-github-actions/setup-gcloud@v2'

#       - name: Configure Docker
#         run: |
#           gcloud auth configure-docker us-central1-docker.pkg.dev

#       - name: Build and Push Docker Image
#         run: |
#           docker build -t ${{ env.DOCKER_IMAGE_URL }}:latest -f Dockerfile.prod .
#           docker push ${{ env.DOCKER_IMAGE_URL }}:latest

#       - name: Deploy to Cloud Run
#         run: |
#           echo SERVICE_NAME $SERVICE_NAME
#           gcloud run deploy $SERVICE_NAME \
#             --image ${{ env.DOCKER_IMAGE_URL }}:latest \
#             --platform managed \
#             --region us-east1 \
#             --allow-unauthenticated